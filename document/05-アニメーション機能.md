# 05. アニメーション機能

[[04-アバター表示機能|← 前へ]] | [[00-INDEX|目次]] | [[06-AI対話機能|次へ →]]

---

## 5.1 概要

アバターの動きを制御するアニメーションシステム。
事前定義された[[16-用語集#GLB|GLBアニメーション]]ファイルを使用。

> **重要**: カメラ入力は不要。すべて事前定義のアニメーションを使用。

## 5.2 アニメーション階層構造

```mermaid
graph TB
    subgraph "アニメーション優先度システム"
        L4[Priority 4: リップシンク<br/>最優先・並行実行可能]
        L3[Priority 3: ジェスチャー<br/>アイドルモーション中断]
        L2[Priority 2: 表情制御<br/>並行実行可能]
        L1[Priority 1: アイドルモーション<br/>最低優先度]
        L0[Priority 0: 背景アニメーション<br/>呼吸など常時動作]
    end
    
    L4 -.並行.-> L3
    L4 -.並行.-> L2
    L3 -->|中断| L1
    L2 -.並行.-> L1
    L1 -.並行.-> L0
    
    style L4 fill:#ff6b6b
    style L3 fill:#feca57
    style L2 fill:#48dbfb
    style L1 fill:#1dd1a1
    style L0 fill:#c8d6e5
```

### 優先度定義

| Priority | 種類 | 動作 | 関連セクション |
|----------|------|------|--------------|
| 4 | リップシンク | 最優先、他と並行可能 | [[#5.3 リップシンク]] |
| 3 | ジェスチャー | アイドル中断 | [[#5.4 ジェスチャー]] |
| 2 | 表情 | 他と並行可能 | [[#5.5 表情制御]] |
| 1 | アイドル | 最低優先度 | [[#5.6 アイドルモーション]] |
| 0 | 背景 | 常時動作 | [[#5.6 アイドルモーション]] |

関連: [[09-データ構造#AnimationPriority|データ構造]]

## 5.3 リップシンク

### 概要

[[16-用語集#リップシンク|リップシンク]]は音声と口の動きを同期させる技術。
[[03-技術スタック#Rhubarb|Rhubarb Lip Sync]]で音素を抽出し、
[[16-用語集#Viseme|Viseme]]に変換して[[04-アバター表示機能#BlendShape|BlendShape]]を制御。

### 処理フロー

```mermaid
sequenceDiagram
    participant Audio as 音声データ
    participant Rhubarb as Rhubarb<br/>Lip Sync
    participant Mapper as Viseme<br/>Mapper
    participant VRM as VRM<br/>BlendShape
    
    Audio->>Rhubarb: WAV/MP3ファイル
    Rhubarb->>Rhubarb: 音素解析
    Rhubarb->>Mapper: 音素タイムライン<br/>[A, B, C, D, E, F, X]
    Mapper->>Mapper: 音素→Visemeマッピング
    Note over Mapper: A→mouth_a<br/>B→mouth_i<br/>C→mouth_u<br/>D→mouth_e<br/>E→mouth_o<br/>F→mouth_close<br/>X→mouth_close
    Mapper->>VRM: BlendShape値<br/>(0.0-1.0)
    VRM->>VRM: 口の形状変化<br/>30fps
```

### Visemeマッピング

| Rhubarb音素 | 発音 | Viseme | VRM BlendShape | 値 |
|------------|------|--------|----------------|-----|
| A | あ | aa | mouth_a | 1.0 |
| B | い | ih | mouth_i | 1.0 |
| C | う | uw | mouth_u | 1.0 |
| D | え | eh | mouth_e | 1.0 |
| E | お | oh | mouth_o | 1.0 |
| F | ん,m | nn | mouth_close | 0.8 |
| X | 閉じ | silent | mouth_close | 0.0 |

### リップシンクデータ構造

```typescript
interface LipSyncData {
  duration: number;        // 秒
  mouthCues: MouthCue[];
}

interface MouthCue {
  start: number;   // 開始時間(秒)
  end: number;     // 終了時間(秒)
  value: string;   // 音素 (A,B,C,D,E,F,X)
}
```

### 実装例

```typescript
class LipSyncController {
  private currentData: LipSyncData | null = null;
  private currentTime: number = 0;
  
  loadLipSyncData(data: LipSyncData) {
    this.currentData = data;
    this.currentTime = 0;
  }
  
  update(deltaTime: number) {
    if (!this.currentData) return;
    
    this.currentTime += deltaTime;
    
    // 現在の音素を取得
    const cue = this.getCurrentCue();
    if (cue) {
      const viseme = this.mapToViseme(cue.value);
      this.applyViseme(viseme);
    }
  }
  
  private mapToViseme(phoneme: string): string {
    const map: Record<string, string> = {
      'A': 'mouth_a',
      'B': 'mouth_i',
      'C': 'mouth_u',
      'D': 'mouth_e',
      'E': 'mouth_o',
      'F': 'mouth_close',
      'X': 'mouth_close'
    };
    return map[phoneme] || 'mouth_close';
  }
}
```

関連:
- [[06-AI対話機能#音声合成|AI対話機能 - 音声合成]]
- [[10-API仕様#LipSyncデータ|API仕様]]

## 5.4 ジェスチャー

### 概要

事前定義されたGLBアニメーションファイルを使用。
[[06-AI対話機能#感情分析|AIの感情分析]]やキーワードに基づいてトリガー。

### ジェスチャー一覧

| アニメーション | ファイル | トリガー条件 | 再生時間 | 優先度 |
|---------------|---------|-------------|---------|-------|
| 挨拶 | greeting.glb | 「こんにちは」含む | 2.5秒 | 3 |
| 指差し | pointing.glb | 「これ」「あれ」含む | 2.0秒 | 3 |
| 頷き | nodding.glb | 肯定的な返答 | 1.5秒 | 3 |
| 考え中 | thinking.glb | 質問への回答開始時 | 3.0秒 | 3 |
| 説明 | explaining.glb | 説明中（デフォルト） | 3.5秒 | 3 |
| 喜び | celebrating.glb | happy感情 | 2.8秒 | 3 |
| 肩すくめ | shrugging.glb | 不明・分からない | 2.5秒 | 3 |
| 同意 | agreeing.glb | 同意・確認 | 2.0秒 | 3 |

### トリガーシステム

```mermaid
graph TB
    subgraph "ジェスチャートリガーシステム"
        Input[AI回答テキスト]
        
        Input --> KW[キーワード検出]
        Input --> EM[感情分析]
        Input --> CTX[文脈分析]
        
        KW -->|"こんにちは"| G1[greeting.glb]
        KW -->|"これ/あれ"| G2[pointing.glb]
        
        EM -->|happy| G6[celebrating.glb]
        EM -->|thinking| G4[thinking.glb]
        
        CTX -->|質問応答| G4
        CTX -->|説明中| G5[explaining.glb]
        CTX -->|同意| G8[agreeing.glb]
        
        G1 --> Play[アニメーション再生]
        G2 --> Play
        G4 --> Play
        G5 --> Play
        G6 --> Play
        G8 --> Play
    end
```

### アニメーション選択ロジック

```typescript
const animationTriggers = {
  // キーワードベース
  keywords: {
    'こんにちは': 'greeting',
    'やあ': 'greeting',
    'これ': 'pointing',
    'あれ': 'pointing',
    'そうだね': 'nodding',
    'すごい': 'celebrating',
  },
  
  // 感情ベース
  emotions: {
    'happy': ['celebrating', 'nodding'],
    'sad': ['shrugging'],
    'surprised': ['surprised'],
    'thinking': ['thinking'],
    'neutral': ['explaining'],
  },
};

function selectAnimation(text: string, emotion: string): string {
  // 1. キーワード優先
  for (const [keyword, animation] of Object.entries(animationTriggers.keywords)) {
    if (text.includes(keyword)) return animation;
  }
  
  // 2. 感情ベース
  const emotionAnims = animationTriggers.emotions[emotion];
  if (emotionAnims) {
    return emotionAnims[Math.floor(Math.random() * emotionAnims.length)];
  }
  
  // 3. デフォルト
  return 'explaining';
}
```

### アニメーション取得方法

**1. Mixamo（推奨・無料）**
```
URL: https://www.mixamo.com/
特徴:
  ✓ 大量のモーションデータ
  ✓ 完全無料
  ✓ FBX/GLB形式でダウンロード
  ✓ VRMに変換可能
```

**2. VRoid Hub**
```
URL: https://hub.vroid.com/
特徴:
  ✓ VRM専用アニメーション
  ✓ そのまま使用可能
```

**3. Blender（自作）**
```
ツール: Blender + VRM Addon
特徴:
  ✓ カスタムアニメーション作成
  ✓ 完全なコントロール
  ✓ 学習コスト高い
```

関連: [[11-ファイル構成#アニメーションファイル|ファイル構成]]

## 5.5 表情制御

### 概要

[[04-アバター表示機能#BlendShape|BlendShape]]を使用した表情変化。
[[06-AI対話機能#感情分析|AI感情分析]]結果に基づいて表情を設定。

### 表情マッピング

```mermaid
graph LR
    subgraph "感情分析結果"
        E1[happy]
        E2[sad]
        E3[surprised]
        E4[neutral]
        E5[thinking]
    end
    
    subgraph "BlendShape制御"
        B1[joy: 1.0]
        B2[sorrow: 0.8]
        B3[surprised: 1.0]
        B4[neutral: 1.0]
        B5[blink: 0.3<br/>lookUp]
    end
    
    E1 --> B1
    E2 --> B2
    E3 --> B3
    E4 --> B4
    E5 --> B5
    
    style E1 fill:#ffd93d
    style E2 fill:#6bceff
    style E3 fill:#ff6348
    style E4 fill:#95afc0
    style E5 fill:#c7ecee
```

### 表情定義

| 感情 | BlendShape | 値 | 説明 |
|------|-----------|-----|------|
| happy | joy | 1.0 | 笑顔 |
| sad | sorrow | 0.8 | 悲しみ |
| surprised | surprised | 1.0 | 驚き |
| neutral | neutral | 1.0 | 通常 |
| thinking | blink + lookUp | 0.3 + 適用 | 考え中 |

### 実装例

```typescript
class EmotionController {
  private vrm: VRM;
  
  setEmotion(emotion: EmotionType, intensity: number = 1.0) {
    const expressionManager = this.vrm.expressionManager;
    
    // すべての表情をリセット
    this.resetExpressions();
    
    // 感情に応じた表情を設定
    switch (emotion) {
      case 'happy':
        expressionManager.setValue('joy', intensity);
        break;
      case 'sad':
        expressionManager.setValue('sorrow', intensity * 0.8);
        break;
      case 'surprised':
        expressionManager.setValue('surprised', intensity);
        break;
      case 'thinking':
        expressionManager.setValue('blink', 0.3);
        this.lookUp();
        break;
      default:
        expressionManager.setValue('neutral', 1.0);
    }
    
    expressionManager.update();
  }
}
```

### 表情遷移

```
遷移時間: 0.5秒
補間: イージング（ease-in-out）
```

## 5.6 アイドルモーション

### 概要

ユーザーが何も操作していない待機時に実行されるランダムなモーション。
「放置ゲー」のようなイメージ。

### モーション一覧

| モーション | ファイル | 特性 | 実行間隔 | 再生時間 | weight |
|-----------|---------|------|---------|---------|--------|
| 呼吸 | breathing.glb | 常時ループ | - | ループ | 1.0 |
| まばたき | blink.glb | 高頻度 | 2-5秒 | 0.5秒 | 0.5 |
| 視線移動 | lookAround.glb | 低頻度 | 10-20秒 | 4.0秒 | 0.2 |
| 伸び | stretch.glb | 低頻度 | 30-60秒 | 3.0秒 | 0.1 |
| 服を直す | adjustClothes.glb | 中頻度 | 20-40秒 | 2.5秒 | 0.15 |
| 体重移動 | idleShift.glb | 中頻度 | 8-15秒 | 2.0秒 | 0.3 |

### 実行フロー

```mermaid
stateDiagram-v2
    [*] --> Breathing: 常時ループ
    
    Breathing --> CheckTimer: 5秒ごと
    
    CheckTimer --> SelectMotion: クールダウン<br/>チェック
    
    SelectMotion --> Blink: weight=0.5
    SelectMotion --> LookAround: weight=0.2
    SelectMotion --> Stretch: weight=0.1
    SelectMotion --> Adjust: weight=0.15
    SelectMotion --> Shift: weight=0.3
    SelectMotion --> Skip: すべてクールダウン中
    
    Blink --> Breathing: 0.5秒後
    LookAround --> Breathing: 4.0秒後
    Stretch --> Breathing: 3.0秒後
    Adjust --> Breathing: 2.5秒後
    Shift --> Breathing: 2.0秒後
    Skip --> Breathing
    
    note right of Breathing
        breathing.glb
        常時実行
    end note
    
    note right of Blink
        間隔: 2-5秒
        クールダウン: 3秒
    end note
    
    note right of LookAround
        間隔: 10-20秒
        クールダウン: 10秒
    end note
```

### 実装例

```typescript
interface IdleMotion {
  name: string;
  animation: string;
  minInterval: number;
  maxInterval: number;
  duration: number;
  weight: number;
  cooldown: number;
}

class IdleMotionController {
  private motions: IdleMotion[] = [
    {
      name: 'breathing',
      animation: 'breathing.glb',
      minInterval: 0,
      maxInterval: 0,
      duration: 0,  // ループ
      weight: 1.0,
      cooldown: 0
    },
    {
      name: 'blink',
      animation: 'blink.glb',
      minInterval: 2000,
      maxInterval: 5000,
      duration: 500,
      weight: 0.5,
      cooldown: 3000
    },
    // ... 他のモーション
  ];
  
  private lastExecution: Map<string, number> = new Map();
  
  selectNextMotion(): IdleMotion | null {
    const now = Date.now();
    const available = this.motions.filter(m => {
      const lastTime = this.lastExecution.get(m.name) || 0;
      return now - lastTime >= m.cooldown;
    });
    
    // 重み付きランダム選択
    const totalWeight = available.reduce((sum, m) => sum + m.weight, 0);
    let random = Math.random() * totalWeight;
    
    for (const motion of available) {
      random -= motion.weight;
      if (random <= 0) {
        this.lastExecution.set(motion.name, now);
        return motion;
      }
    }
    
    return null;
  }
  
  start() {
    // 呼吸アニメーション開始
    this.playAnimation('breathing', true);
    
    // 5秒ごとにチェック
    setInterval(() => {
      const motion = this.selectNextMotion();
      if (motion && motion.name !== 'breathing') {
        this.playAnimation(motion.animation, false);
      }
    }, 5000);
  }
}
```

関連: [[09-データ構造#IdleMotionController|データ構造]]

## 5.7 アニメーション遷移

### 遷移フロー

```mermaid
graph TB
    Start([アニメーション開始])
    
    Start --> Check{現在のアニメーション<br/>優先度チェック}
    
    Check -->|新 > 現| Interrupt[現在のアニメーション<br/>フェードアウト 0.3秒]
    Check -->|新 <= 現| Queue[キューに追加]
    
    Interrupt --> FadeIn[新アニメーション<br/>フェードイン 0.3秒]
    
    FadeIn --> Play[アニメーション再生]
    
    Play --> End{再生完了?}
    
    End -->|No| Play
    End -->|Yes| FadeOut[フェードアウト 0.3秒]
    
    FadeOut --> CheckQueue{キューに<br/>アニメーション?}
    
    CheckQueue -->|Yes| Start
    CheckQueue -->|No| Idle[アイドルモーション<br/>に戻る]
    
    Queue --> Wait[待機]
    Wait --> CheckQueue
```

### 遷移パラメータ

| 項目 | 値 | 説明 |
|------|-----|------|
| フェードイン | 0.3秒 | 新アニメーション開始時 |
| フェードアウト | 0.3秒 | アニメーション終了時 |
| ブレンド方式 | 線形補間 | アニメーション間の補間 |

### 実装例

```typescript
class AnimationController {
  private currentAnimations: Map<AnimationPriority, THREE.AnimationAction> = new Map();
  
  playAnimation(
    animation: THREE.AnimationClip,
    priority: AnimationPriority,
    loop: boolean = false
  ) {
    // 優先度チェック
    for (const [p, action] of this.currentAnimations) {
      if (p < priority) {
        // 優先度が低いアニメーションは中断
        action.fadeOut(0.3);
        this.currentAnimations.delete(p);
      }
    }
    
    // 新しいアニメーション再生
    const action = this.mixer.clipAction(animation);
    action.setLoop(loop ? THREE.LoopRepeat : THREE.LoopOnce, Infinity);
    action.fadeIn(0.3);
    action.play();
    
    this.currentAnimations.set(priority, action);
  }
}
```

関連: [[09-データ構造#AnimationController|データ構造]]

## 5.8 関連ドキュメント

- [[04-アバター表示機能|アバター表示機能]] - アバターの基本設定
- [[06-AI対話機能|AI対話機能]] - 感情分析とトリガー
- [[09-データ構造|データ構造]] - コントローラークラス
- [[11-ファイル構成|ファイル構成]] - アニメーションファイル配置

---

**タグ**: #アニメーション #リップシンク #ジェスチャー #表情
**更新日**: 2025-10-30
